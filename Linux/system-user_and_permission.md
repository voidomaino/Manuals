# 权限

## 用户

用户就是一个账号，包括一个由字符串表示的用户名和由另一个字符串表示的密码。当用户创建帐户之后，系统会给用户分配一个号码，叫做用户 ID 或者 `UID`，这个 ID 映射到一个用户名。

| `UID` 范围 | 使用者特性 |
| ---- | ---- |
| 0 | 代表这个账号是「系统管理员」拥有至高无上的权利 |
| 1~999 | 代表这个账号是「系统账号」，用于以较小的权限去执行网络服务或后台服务 |
| 1000~60000 | 代表这个账号是「一般使用者」 |

### 相关文件

`/etc/passwd` 定义了计算机上存在的所有账号，其中很多都是维持系统正常运作的程序（系统账号）。

`/etc/passwd` 中每行包含一个用户的以下信息：

* 用户名
* 密码（经过加密后只能看到 `X`）
* `UID`
* `GID`
* 全名（真正的用户反而没有，都是一些程序的真名）
* 用户家目录
* 终端

这些信息用冒号 `:` 隔开。

`/etc/shadow` 中包含每个用户的密码。

`/etc/shadow` 中每行包含一个用户的以下信息：

* 账号名称
* 密码（经过加密编码）
* 最近改变密码的日期（从1970年1月1日开始）
* 密码锁定的天数
* 密码需要改变的天数（培养勤换密码的好习惯）
* 密码需要改变的警告天数
* 密码过期后的宽限天数
* 账号失效日期

这些信息用冒号 `:` 隔开。

`/etc/sudoers` 规范 `sudo` 命令执行时的细节，使得一般用户有机会染指其它用户的权限。此文件有特定的格式，可参考文件内的说明。

```sudoers
root    ALL=(ALL)   ALL
```

这样的一行中四个变量的意思是：

1. 使用者账号：加上 `%` 百分号表示组名称，如 `%wheel`
2. 可下达指令的主机名称：用于服务器，对于个人电脑只能是 `ALL` 了
3. 可切换的身份
4. 可下达的指令

### 相关命令

`root` 可以通过 `useradd` 命令新建用户。

`root` 可以通过 `passwd` 命令创建和修改密码，其它用户也可以以此修改自己的密码。

`autoconfig --test | grep hashing` 查询 `/etc/shadow` 的密码加密机制。

`root` 可以通过 `chage` 命令设定修改密码的相关参数。

`root` 可以通过 `usermod` 命令设定用户的各种信息（名称、家目录、群组和终端等，除了密码），甚至冻结与解冻用户。

`root` 可以通过 `userdel` 命令删除用户。

`root` 可以通过 `visudo` 命令改变 `sudo` 命令的设定。

一般用户可以通过 `id` 查询所有用户的基本信息。

一般用户可以通过 `chsh` 改变自己使用的终端。

一般用户可以通过 `su` 命令改变登录用户。

一般用户可以通过 `sudo` 命令以其他用户的身份执行命令。

## 群组

一个或多个用户组成群组。同一个群组的成员分享组内文件的权限。

当用户创建帐户之后，系统会给这个用户分配一个原始的 `GID`，这个 `GID` 称为「初始群组」，当使用者登入系统，立刻拥有该群组的相关权限。使用过程中用户可能加入多个群组，但是「有效群组」，即用户创建新文件时，文件显示的群组只有一个。

### 相关文件

`/etc/group` 定义群组。

`/etc/group` 中每行包含一个群组的以下信息：

* 群组名称
* 群组密码（经过加密后只能看到 `X`）
* `GID`
* 群组成员的账号名称（用逗号分隔）

这些信息用冒号 `:` 隔开。

> 群组管理员由 `/etc/gshadow` 定义，这种用户可以将其它用户拉入或移出群组，节省 `root` 用户的时间和精力。但是由于 `sudo` 的工具，在个人电脑上没有必要进行如此精细的设置。
### 相关命令

`root` 用户可以通过 `groupadd` 创建新的群组。

`root` 用户可以通过 `groupmod` 修改群组的 `GID` 和名称。

`root` 用户可以通过 `usermod` 命令或修改 `/etc/group` 文件可以使一个用户加入多个群组。

`root` 用户可以通过 `groupdel` 删除群组。

通过 `groups` 命令查看用户加入的所有群组，显示结果的第一个为有效群组。

通过 `newgrp` 切换有效群组，用户只能切换到已加入的群组。此时用户进入一个新的 `shell` 会话，在这里创建的文件会显示为新的群组，退出此 `shell` 回到初始的群组。

有三种方式，可以拥有多重身份：

1. 注销系统并以其他用户身份重新登录系统。
2. 使用 `su` 命令。`su` 命令允许你假定为另一个用户的身份，以这个用户的 ID 启动一 个新的 `shell` 会话，或者是以这个用户的身份来发布一个命令。
3. 使用 `sudo` 命令。`sudo` 命令允许一个管理员设置一个叫做 `/etc/sudoers` 的配置文件，并且定义了一些具体命令，在假定的身份下，特殊用户可以执行这些命令。

## 文件

在 `Unix` 安全模型中，一个用户可能拥有文件和目录。当一个用户拥有一个文件或目录时，用户对这个文件或目录的访问权限拥有控制权。

文件对三个群体区分权限，分别是拥有者、文件组和其他人。

```shell
> foo.txt
ls -l foo.txt
-rw-rw-r--  1   me me  0    2008-03-06  14:52   foo.txt
```

列表的前十个字符是文件的属性。这十个字符的第一个字符表明文件类型。

| 符号 | 文件类型 |
| ---- | ---- |
| `d` | 目录 |
| `-` | 文件 |
| `l` | 链接 |
| `b` | 存储设备 |
| `c` | 输入设备（键盘或鼠标等） |

剩下的九个字符叫做文件模式，三个字符一组，分别代表着文件所有者、文件组所有者和其他人的读、写和执行权限。

当设置文件模式后，`r`、`w` 和 `x` 模式属性对文件和目录会产生以下影响：

| 属性  | 文件  | 目录  |
| :---: | :---: | :---: |
| r | 允许打开并读取文件内容。                                                                          | 允许列出目录中的内容，前提是目录必须设置了可执行属性（`x`）。                 |
| w | 允许写入文件内容或截断文件。但是不允许对文件进行重命名或删除，重命名或删除是由目录的属性决定的。  | 允许在目录下新建、删除或重命名文件，前提是目录必须设置了可执行属性（`x`）。   |
| x | 允许将文件作为程序来执行，使用脚本语言编写的程序必须设置为可读才能被执行。                        | 允许进入目录。                                                                |

常用一个八进制数字表示文件或目录对一个群体的权限状态。

| 八进制数字    | 二进制数字    | 权限  |
| :---:         | :---:         | :---: |
| 0             | 000           | `---` |
| 1             | 001           | `--x` |
| 2             | 010           | `-w-` |
| 3             | 011           | `-wx` |
| 4             | 100           | `r--` |
| 5             | 101           | `r-x` |
| 6             | 110           | `rw-` |
| 7             | 111           | `rwx` |

### 相关命令

`umask` 命令控制着文件的默认权限。`umask` 后接一个四位参数，其中第一位必为 `0`，后面三位八进制数表示要从默认状态删除的权限。默认状态为 `rw-rw-rw-`。

第一位的 `0` 在其它情况下表示 `setuid` 位、`setgid` 位或 `sticky` 位。

```shell
umask 0022
```

`chmod` 命令可以改变文件或目录的模式。对每一个对象（所有者、群组成员和其它人）的三个权限用一个八进制数字表示。也可以用一个由逗号分隔的字符串表示。

```shell
chmod 600 foo.txt
chmod u=rwx,go=rx foo.txt # + 添加；- 移除；= 设为
```

`chgrp` 命令可以改变文件的所属群组。

`chown` 命令被用来更改文件或目录的所有者和群组。

```shell
chown tony:wheel ~tony/myfile.txt
```
