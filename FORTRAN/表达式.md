# 表达式

表达式是程序中进行数据处理的主体。
一个完整的表达式由数据、操作符、括号构成。
数据处理的结果，就成为表达式的值。
表达式的值也可以作为数据插入到其他类型的数据当中。

除了这些基础的表达式外，函数也是重要的数据处理方式，
函数可以嵌入到表达式中，实现多种类型的功能。

一个表达式可以由不同的表达式组合而成，对于混合表达式，以如下先后顺序计算：

1. 算术表达式或字符表达式
2. 关系表达式
3. 逻辑表达式

## 算术表达式

算术表达式的操作数为各种数值型数据；
操作符为 `+ - * / **`，表达式的值也是数值型数据。

### 运算符

算术运算符有这样的几个特性：

1. 运算次序按照优先级别由高到低开始；
2. **双目运算符** 要求运算符两边有两个操作数，
    **单目运算符** 要求运算符两边有只一个操作数；
    目前所有运算符都是双目运算符，其中 `+ -` 可以作为单目运算符。
3. **左结合** 意味着相邻统计运算符从左向右运算，
    **右结合**表示从右向左。

算术运算的运算符如下表所示：

| 运算优先级 | 运算符           | 结合规则      |
| ---------- | ---------------- | --------      |
| 1          | `**` 乘方        | 右结合        |
| 2          | `*` `/` 乘除     | 左结合        |
| 3          | `+` `-` 单目加减 | 单目运算符    |
| 4          | `+` `-` 双目加减 | 左结合        |

### 操作数类型变换

当不同类型的两个数值型数据进行算术运算，
表达式值的类型和 `KIND` 值继承优先级高的操作数。

当相同类型的两个数值型数据进行算术运算，
表达式值的 `KIND` 值继承 `KIND` 值最大的操作数。

### 误差

整型表达式运算结果很精确，但是会产生数值溢出误差，
可以通过扩大 `KIND` 值来解决。

实型表达式容易产生误差，可以通过这样的方式解决：
1. 交换加减运算次序，避免两个相差很大的数相加减；
2. 交换乘除运算次序，避免讲过非整除的数向除；

## 字符表达式

字符表达式的
操作数为字符型数据和整型数值型数据，
操作符为 `:` 和 `//`，
表达式的值为字符型数据。

### 求子串操作

```fortran
<字符串>([<子串下界表达式>]:[<子串上界表达式>])
```

子串下界表达式值为整型，指定子串在父串中的起始位置，默认为 `1`。

子串上界表达式值为整型，指定子串在父串中的终止位置，默认为父串的长度 `LEN`。

子串上界表达式的值必须大于等于子串下界表达式，否则子串为空串。

### 连接操作

```BNF
<字符串>//<字符串>
```

## 关系表达式

关系表达式的
操作数为字符型数据和数值型数据，
操作符为六个关系运算符，
表达式的值为 `KIND = 4` 的逻辑型数据。

关系运算符的功能如下：

| 关系运算符  | 功能     |
| ----------- | -------- |
| `.LT.` `<`  | 小于     |
| `.LE.` `<=` | 小于等于 |
| `.EQ.` `==` | 等于     |
| `.NE.` `/=` | 不等于   |
| `.GT.` `>`  | 大于     |
| `.GE.` `>=` | 大于等于 |

如果左右操作数为算术表达式，运算前将算术表达式的值转化成下一个数值类型；
最后根据表达式两边的值的大小得到结果。

如果左右操作数为字符表达式，运算前将字符表达式的值转换成等长字符串，
如果不足，就在末尾补充空格；
最后依次比较两字符串相应位置字符的 ASCII 码值的大小来决定结果。

复数没有大小的比较，只有是否等于。

实型数据的关系表达式容易产生误差，
避免使用等于而是使用小于一个很小的数来避免实型数据的比较产生精确度误差。

## 逻辑表达式

逻辑表达式的
操作数为逻辑型数据，
操作符为六种逻辑运算符，
表达式的值为逻辑型数据。

和算术表达式一样，逻辑运算符也有三种特性。

| 优先级 | 运算符       | 功能                      | 结合规则   |
| ------ | ------------ | ------------------------- | ---------- |
| 1      | `.NOT. A`    | 对 `A` 取反               | 单目运算符 |
| 2      | `A .AND. B`  | `A` 与 `B` 为真时，值为真 | 左结合     |
| 3      | `A .OR. B`   | `A` 或 `B` 为真时，值为真 | 左结合     |
| 4      | `A .XOR. B`  | `A` 和 `B` 不同时，值为真 | 左结合     |
| 4      | `A .EQV. B`  | `A` 和 `B` 相同时，值为真 | 左结合     |
| 4      | `A .NEQV. B` | `A` 和 `B` 不同时，值为真 | 左结合     |
