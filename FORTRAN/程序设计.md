# 程序结构设计

## 程序结构

一个 FORTRAN 程序必有一个主程序单元，其后可接
外部子程序单元、模块单元和数据块单元。

**主程序单元** 
第一行必为一个 `PROGRAM` 语句，最后一行必为一个 `END` 语句，中间的内容依次为：
说明部分、操作部分和内部子程序部分。

**说明部分** 
包括程序中的各种类型说明语句。如果一个名称没有说明，其在后面的程序中将无法使用。
说明部分可能出现
内部数据类型说明语句、
派生数据类型说明语句、
数组类型说明语句和
指针类型说明语句。

**操作部分** 
包括各种可执行语句。

**内部子程序部分** 
以 `CONTAINS` 语句开头，包含可被主程序单元调用的内部子程序。

**外部子程序单元** 
是由不包含在主程序单元、
模块单元和
其他外部子程序单元中的函数或子例行程序所构建的程序单元，
能够被其他程序单元调用执行。

外部子程序单元以 `FUNCTION` 或 `SUBROUTINE` 语句开头。

**模块单元** 
是由能够被其他程序单元访问的一组定义
（
数据实体定义、
数据类型定义、
过程定义或
过程接口定义
）
所构成的程序单元。
其中过程定义又称为模块子程序，允许被模块中其他模块子程序访问。

模块单元以 `MODULE` 语句开头。

**数据块单元** 
是命名公用区中变量指定初始值的程序单元，不可被执行。

数据块单元以 `block data` 语句开头。


## 语句

语句可以说是程序的主体了。**可执行语句**表示程序要完成的某个操作；**非可执行语句**描述程序的某种属性（数据的特性、编辑、转换等信息）。

语句要求按规定次序排列。以下语句次序由先往后排列：

1. `option`
2. `program` `function` `subroutine` `module` `block data`
3. `use`
4. `implicit none` `namelist` `format` `entry`
5. `parameter` `lmplicit` `namelist` `format` `entry`
6. `parameter` `data` `namelist` `format` `entry` 其他定义、说明类语句
7. `data` `namelist` `format` `entry` 可执行语句
8. `contains`
9. 内部子程序或模块子程序
10. `end`

注释行，`include` 可以插入在 `end` 之前的所有行内。

在程序单元内有的语句是不能使用的。


## 顺序结构

程序从第一行开始向下运行，最简单的结构。

## 选择结构

根据不同的条件判断结果来决定执行不同的分支语句。

### IF

if 语句是各种语言中的常见选择表达，故不再赘述。

在 Fortran 中，if 语句有三种形式，根据复杂程度依次递进：

（1）逻辑 if 语句

```BNF
<逻辑 if 语句> ::= if "(" <逻辑表达式> ")" <语句 s>
```

若逻辑表达式的值为真，则执行语句 s；若表达式的值为假，则不执行。

（2）块 if 语句

```BNF
<基本块 if 语句> ::= 
if "(" <逻辑表达式> ")" then
 [<then 语句体>]
 [else
 [<else 语句体>]]
 end if
```

（3）多重块 if 语句

```BNF
<多块 if 语句> ::=
[<语句名称>:] if "(" <逻辑表达式 1> ")" then
 [语句体 1]
 else if "(" <逻辑表达式 2> ")" then
 [语句体 2]
 ...
 else if "(" <逻辑表达式 n> ")" then
 [语句体 n]
 [else
 [语句体 n+1]]
 end if <语句名称>
```

对 if 语句命名可以避免在嵌套的时候搞混。

### CASE

块 case 选择结构类似多分支选择结构，根据表达式的计算结果，从多个分支中选择一个执行。

```BNF
<select 语句> ::= 
 select case (<表达式 e>)
  case (<控制集合 1>)
  <语句体 1>
  case (<控制集合 2>)
  <语句体 2>
  ...
  case (<控制集合 n>)
  <语句体 n>
  [case default
  <语句体 n+1>]
 end select
<表达式 e> ::= 整型表达式|字符型表达式|逻辑表达式
<控制集合> ::= <元素>[:<元素>]{,<元素>[:<元素>]}
```

元素是一个具有 `<表达式 e>` 类型的值。

两个不同的控制集合不能有相同的元素。

## 循环结构

根据条件判断结果重复某个操作过程。

循环主要由两个部分组成，**循环体**是指重复执行的处理过程；**循环变量**在每个循环中发生改变，根据循环变量进行循环的控制。

循环次数确定，则循环称为 **计数型循环**；循环次数不确定，则循环称为 **条件型循环**。

条件循环又有两种划分，若先判断条件是否成立，再执行循环体，则为**当型循环**；若先执行循环体，再判断条件是否成立，则为**直到型循环**。两种循环的差别是，直到型循环体至少执行一次。

循环语句可以嵌套，同 if 语句。

### DO

DO 循环用于实现计数型循环结构，可指定循环的次数和范围，其语法描述为：

```BNF
<DO 循环语句> ::= 
[<名字>:] DO <v> = <e1>,<e2>[,<e3>]
<循环体>
END DO [<名字>]
```

`v` 为整型变量，用来代表循环变量；`e1`、`e2` 和 `e3` 分别为初值、终值和步长；这些量的类型应当相同；步长缺省为 1。

如果循环次数不是整数，取整。

在循环体中不能重新给循环变量赋值，否则产生语法错误，但是能在循环体中引用循环变量。

### WHILE

DO WHILE 语句用于实现当型循环。其语法描述为：

```BNF
<do while 循环语句> ::=
[<名字>:] do while (<循环条件>)
 <循环体>
end do [<名字>]
```

`<循环条件>` 的值应为逻辑值。

循环体中应至少有一条对循环条件有影响的语句，否则将产生死循环。

### EXIT

EXIT 语句的功能是，在循环执行过程中强制终止整个循环语句的执行，跳转到 `end do` 后的第一句。

### CYCLE

CYCLE 语句的功能是，在循环执行过程中强制终止本次循环语句的执行，跳转到 `do` 后的第一句。
